# Работа с деревом DOM

## Модель DOM в мире браузеров

В каждом браузере существует две реализации, одна из которых отвечает за интерпретирование языка, а другая - за DOM операции.

## Доступ к дереву DOM и его модификация

Необходимо стараться производить как можно меньше операций с DOM.

### Копирование узлов

    element.cloneNode();

В большинстве браузеров операция копирования более эффективна, чем операция создания нового узла.

### HTML-коллекции

Коллекции являются живыми массивами, поэтому необходимо как можно меньше выполнять непосредственные запросы к ним.

### Локальные переменные при обращении к элементам коллекций

При любых обращениях к элементам дерева DOM желательно использовать локальные переменные, если одно и то же свойство или метод элемента DOM используется более одного раза.

## Перерисовывание и перекомпоновка

При изменении размеров элементов или содержимого происходит *перекомпоновка (reflow)*, то есть пересчитывание геометрии страницы.

Затем происходит *перерисовывание (repaint)*.

Браузеры стараются оптимизировать данные операции, поэтому изменения сначала записываются в буфер, а потом применяются к странице.

При обращении к следующим свойствам происходит немедленное применение всей накопленной информации о размещении:

* offsetTop, offsetLeft, offsetWidth, offsetHeight
* scrollTop, scrollLeft, scrollWidth, scrollHeight
* clientTop, clientLeft, clientWidth, clientHeight
* getComputerStyle() (currentStyle в IE)

В процессе изменения стилей желательно не использовать данные свойства и методы.

## Уменьшение количества операций перерисовывания и перекомпоновки

Операции перекомпоновки и перерисовывания могут приводить к существенным потерям производительности, поэтому желательно уменьшить их количество, чтобы улучшить отзывчивость приложения. Для этого следует объединять множественные изменения стилей и элементов в дереве DOM и применять их группами.

### Изменение стилей

    var el = document.getElementById('mydiv');
    el.style.cssText += '; border-left: 1px; border-right: 2px;; padding: 5px;';

вместо

    var el = document.getElementById('mydiv');    
    el.style.borderLeft = '1px';
    el.style.borderRight = '2px';
    el.style.padding = '5px';

### Группировка изменений в дереве DOM

1. Извлечь элемент из потока отображения документа
2. Применить множество изменений.
3. Вернуть элемент обратно в документ.

Три основных способа выполнения изменений дерева DOM за пределами документа:

* Скрыть элемент, применить изменения и снова отобразить элемент.
* Используя фрагмент документа, сконструировать поддерево за пределами дерева DOM и затем скопировать его в документ.
* Скопировать элемент в узел за пределами документа, изменить копию и затем заменить оригинальный элемент.

## В заключение

* Как можно реже обращайтесь к дереву DOM и старайтесь большую часть работы выполнять на территории JavaScript.
* Используйте локальные переменные для хранения ссылок на элементы в дереве DOM, к которым приходится обращаться многократно.
* С осторожностью используйте HTML-коллекции, потому что они предоставляют синхронную структуру документа. Кэшируйте значение свойства length в переменной и используйте ее при выполнении итераций, а также копируйте коллекцию в массив, когда требуется выполнить большое количество операций с коллекцией.
* Используйте более быстрые API, если доступны, такие как querySelectorAll() и firstElementChild.
* Не забывайте об операциях перерисовывания и перекомпоновки. Группируйте изменения стилей, манипулируйте деревом DOM "в автономном режиме", минимизируйте количество операций чтения информации о размещении и сохраняйте ее в переменных.
* Переводите элементы в режим абсолютного позиционирования перед началом воспроизведения анимационных эффектов.
* Используйте прием делегирования обработки событий для уменьшения количества обработчиков событий.